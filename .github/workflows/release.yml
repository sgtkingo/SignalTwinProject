name: Release (assets + notes + patch bump)

on:
  push:
    branches:
      - main
  workflow_dispatch: {}

permissions:
  contents: write # needed to create tags and releases

jobs:
  release:
    # prevent infinite release loops
    if: "${{ !contains(github.event.head_commit.message, 'chore(release): bump version') }}"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # prevent shallow clone to have tags and full history

      - name: Read and validate version
        id: ver
        shell: bash
        run: |
          set -euo pipefail

          # český komentář: VERSION je jediný zdroj pravdy pro verzi
          if [[ ! -f VERSION ]]; then
            echo "Soubor VERSION neexistuje. Vytvoř ho (např. 1.0.0)." >&2
            exit 1
          fi

          V="$(tr -d ' \r\n\t' < VERSION)"

          # český komentář: jednoduchá validace semver X.Y.Z
          if [[ ! "$V" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Neplatná verze v souboru VERSION: '$V' (očekávám X.Y.Z)" >&2
            exit 1
          fi

          IFS='.' read -r MA MI PA <<< "$V"

          # český komentář: release povolíme až od 1.0.0
          if (( MA < 1 )); then
            echo "Release přeskočen: VERSION < 1.0.0 (aktuálně $V)"
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "skip=false" >> "$GITHUB_OUTPUT"
          echo "version=$V" >> "$GITHUB_OUTPUT"
          echo "tag=v$V" >> "$GITHUB_OUTPUT"

      - name: Stop if release is skipped
        if: ${{ steps.ver.outputs.skip == 'true' }}
        run: |
          echo "Release se neprovádí (VERSION < 1.0.0)." # český komentář: kontrolované ukončení

      - name: Validate assets folder
        if: ${{ steps.ver.outputs.skip == 'false' }}
        shell: bash
        run: |
          set -euo pipefail

          # český komentář: očekáváme binárky v bin/latest
          if [[ ! -d "bin/latest" ]]; then
            echo "Chybí složka bin/latest" >&2
            exit 1
          fi

          shopt -s nullglob
          files=(bin/latest/*)
          if (( ${#files[@]} == 0 )); then
            echo "Ve složce bin/latest nejsou žádné soubory" >&2
            exit 1
          fi

      - name: Create and push tag (if missing)
        if: ${{ steps.ver.outputs.skip == 'false' }}
        shell: bash
        run: |
          set -euo pipefail
          TAG="${{ steps.ver.outputs.tag }}"

          # český komentář: tag vytvoříme jen pokud ještě neexistuje
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "Tag $TAG již existuje."
          else
            git tag "$TAG"
            git push origin "$TAG"
          fi

      - name: Create GitHub Release (assets from bin/latest + notes from RELEASE_NOTES.md)
        if: ${{ steps.ver.outputs.skip == 'false' }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.ver.outputs.tag }}
          name: ${{ steps.ver.outputs.tag }}
          body_path: RELEASE_NOTES.md # release notes
          files: |
            bin/latest/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Bump patch version (+0.0.1) and push to main
        if: ${{ steps.ver.outputs.skip == 'false' }}
        shell: bash
        run: |
          set -euo pipefail

          V="${{ steps.ver.outputs.version }}"
          IFS='.' read -r MA MI PA <<< "$V"
          PA=$((PA + 1))
          NEXT="${MA}.${MI}.${PA}"

          # český komentář: zapíšeme novou verzi
          printf "%s\n" "$NEXT" > VERSION
          echo "Bumped VERSION: $V -> $NEXT"

          # český komentář: commit a push zpět do main
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add VERSION
          git commit -m "chore(release): bump version"
          git push origin HEAD:main
